rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isNotSuspended(userId) {
<<<<<<< HEAD
      return !exists(/databases/$(database)/documents/users/$(userId)) || 
             get(/databases/$(database)/documents/users/$(userId)).data.isSuspended != true;
=======
      return get(/databases/$(database)/documents/users/$(userId)).data.isSuspended != true;
>>>>>>> fbc44eec518ddf89dd9fad935fe552e6bfd55d26
    }

    // Allow public read access for accessories, but restrict writes.
    match /accessories/{accessoryId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users can only read/write their own data if they are not suspended.
    // Admins can read/write any user's data.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        || (
          request.auth.uid == userId &&
          isNotSuspended(userId) &&
          // On update, user cannot change their role, points or suspended status
          (resource == null || // allow create
              (request.resource.data.role == resource.data.role &&
               request.resource.data.points == resource.data.points &&
               request.resource.data.isSuspended == resource.data.isSuspended
              )
          ) &&
          // If socialMediaLink is provided, it must be a valid facebook or instagram URL string
          (
            !('socialMediaLink' in request.resource.data) ||
            request.resource.data.socialMediaLink == null || // allow removing it
            (
              request.resource.data.socialMediaLink is string &&
              (
                request.resource.data.socialMediaLink.matches('^https://(www\\.)?facebook\\.com/.*') ||
                request.resource.data.socialMediaLink.matches('^https://(www\\.)?instagram\\.com/.*')
              )
            )
          )
        )
      );
    }
    
    // Contributions can be created by any authenticated, non-suspended user.
    // They can be read/listed by their author or by an admin.
    // They can only be updated or deleted by admins.
    match /contributions/{contributionId} {
      allow create: if request.auth != null && isNotSuspended(request.auth.uid);

      allow get: if request.auth != null && (
        resource.data.submittedBy == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );

      allow list: if request.auth != null && (
        request.query.where.submittedBy == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );

      allow update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Categories can be read by anyone, but only managed by admins.
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
